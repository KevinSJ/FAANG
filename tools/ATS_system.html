<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS Score with Gemini PRO</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>

<style>
    .response-container {
        border: 1px solid #ddd; /* Light grey border */
        padding: 10px;
        height: auto; /* Fixed height, or you can make it auto */
        overflow-y: auto; /* Allows scrolling if content is too long */
        background-color: #f9f9f9; /* Light background color */
        margin-top: 5px;
        border-radius: 10px; /* Rounded borders */
    }
</style>

<body>
<div class="container">
    <h1 class="text-center mt-4">ATS Score Analysis with Gemini PRO</h1>

    <div class="row mt-4">
        <div class="col-md-6 offset-md-3">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-key"></i> Enter API Key
                </div>
                <div class="card-body">
                    <label for="geminiApiKey"></label><input type="text" class="form-control" id="geminiApiKey" placeholder="Enter your Gemini PRO API key">
                    <label for="chatGpTApiKey"></label><input type="text" class="form-control" id="chatGpTApiKey" placeholder="Enter your ChatGPT API key">
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-file-alt"></i> Enter Resume
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="resume" rows="10"
                              placeholder="Paste the resume text here"></textarea>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-file-alt"></i> Enter Job Description
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="jobDescription" rows="10"
                              placeholder="Paste the job description text here"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <button type="button" class="btn btn-primary btn-block" id="generateResponse">Generate Response</button>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-comment-dots"></i> Prompt Response
                </div>
                <div class="card-body row">
                    <!-- Gemini AI Response Section -->
                    <div class="col-md-6 mb-3">
                        <h5>Gemini AI Response:</h5>
                        <div id="gemini-response" class="response-container"></div>
                    </div>
                    <!-- ChatGPT Response Section -->
                    <div class="col-md-6 mb-3">
                        <h5>ChatGPT Response:</h5>
                        <div id="chatgpt-response" class="response-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>

<script src="https://kit.fontawesome.com/a076d05399.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>

<script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
</script>

<script type="module">
    import {GoogleGenerativeAI} from "@google/generative-ai";

    const generateResponseButton = document.getElementById("generateResponse");
    const responseElement = document.getElementById("response");
    let CHATGPT_API_KEY = document.getElementById("chatGpTApiKey").value;
    let GEMINI_API_KEY = document.getElementById("geminiApiKey").value;

    const loadingIcon = document.createElement("i"); // Create a loading icon element
    loadingIcon.classList.add("fas", "fa-spinner", "fa-spin");

    window.addEventListener('load', () => {
        retriveLocalStrorageValues();
    });

    generateResponseButton.addEventListener("click", async () => {

        // Get the original values for preservation
        const originalResumeText = document.getElementById("resume").value;
        const originalJobDescriptionText = document.getElementById("jobDescription").value;

        try {
            CHATGPT_API_KEY = document.getElementById("chatGpTApiKey").value;
            GEMINI_API_KEY = document.getElementById("geminiApiKey").value;

            setLocalStorage(GEMINI_API_KEY, CHATGPT_API_KEY, originalResumeText, originalJobDescriptionText);
            // Disable the button and show the loading icon
            generateResponseButton.disabled = true;
            generateResponseButton.appendChild(loadingIcon);

            const resumeText = document.getElementById("resume").value;
            const jobDescriptionText = document.getElementById("jobDescription").value;
            const promptPrefix = "Hey, Act Like, a skilled or very experience ATS (Application Tracking System)\n" +
                "with a deep understanding of tech field, software engineering." +
                "Your task is to thoroughly go through the resume line by line Have a get a better understanding of teh context." +
                "Evaluate the resume based on the given job description. You must consider the job market is very competitive and you should provide. \n" +
                "Give your best assistance for improving the resumes, remember to use the same tone of the resume give me just the points that you want to update in which sections.\n" +
                "\n" +
                "Assign the percentage Matching based on the below Job Description and the missing keywords with high accuracy.\n" +
                "\n" +
                "--------------\n" +
                "Resume:" +
                "\n";

            const resumePromptPrefix = "--------------\n" +
                "Job description:" +
                "\n";

            const jdPromptPrefix = "--------------\n" +
                "Job description:" +
                "\n";

            const promptPrefix3 = "--------------\n" +
                "I dont want the complete Updated resume. I am looking for the things that I have to change. " +
                "Focus Primarily on the Essential Duties or Responsibilities and the Qualifications. Understand the requirement first very carefully." +
                "Give it in below format." +
                "Only then start Generating the response in Below format" +
                "JD Match (In %): ?\n" +
                "MissingKeywords (as list):?\n" +
                "And Updated resume, I dont want the complete Updated resume. I am looking for the things that I have to change in my resume:\n " +
                "Give me details like:  " +
                " 1. Summary Section: " +
                "     Old Content: Seasoned Software Architect with 12+ years of experience in designing and implementing large-scale distributed systems" +
                "     Updated Content: Experienced Cloud Systems Engineer with over 12 years in software architecture, specializing in cloud solutions, system engineering processes, and data integration for secure, distributed systems. Skilled in aligning software platforms with Department of Defense standards, ensuring robust and scalable solutions for data federation and edge device integration." +
                " 2. Work Experience" +
                "   - In Principal Software Engineer, WAYFAIR, Tampa, FL, USA. " +
                "       Old Content: {Give the existing content of the Resume.}" +
                "       Updated Content: {Give the Updated content so that the ATS Score of the resume is improved.}" +
                "" +
                "Make sure when you create the updated content keeping in mind the ATS score must go above 85 %." +
                "\n";

            const finalPrompt = promptPrefix + resumePromptPrefix + resumeText + jdPromptPrefix + jobDescriptionText + promptPrefix3;

            const context = promptPrefix + promptPrefix3

            getGoogleAIResponse(finalPrompt);
            getChatGPTResponse(context, resumePromptPrefix + resumeText + jdPromptPrefix + jobDescriptionText);

            retriveLocalStrorageValues();

            const promises = [
                await getGoogleAIResponse(helperPrompt, recordedTextValue),
                await getChatGPTResponse(helperPrompt, recordedTextValue)
            ];

            const responses = await Promise.all(promises);
            const [geminiAIResponse, chatGPTAIResponse] = responses;

            console.log("Gemini AI Response : \n" + geminiAIResponse);
            console.log("Chat GPT Response : \n" + chatGPTAIResponse);

            generateResponseButton.disabled = false;
            generateResponseButton.removeChild(loadingIcon);

        } catch (error) {
            responseElement.innerHTML = error;
        } finally {

            // Re-enable the button and remove the loading icon
            generateResponseButton.disabled = false;
            generateResponseButton.removeChild(loadingIcon);
        }

        retriveLocalStrorageValues();

    });

    function updateGeminiResponse(response) {
        const geminiResponseElement = document.getElementById('gemini-response');
        geminiResponseElement.innerHTML = response; // Assuming HTML formatted response
    }

    function updateChatGptResponse(response) {
        const chatGptResponseElement = document.getElementById('chatgpt-response');
        chatGptResponseElement.innerHTML = response; // Assuming HTML formatted response
    }


    async function getGoogleAIResponse(finalPrompt, aiModel = "gemini-pro") {

        // Access your API key (see "Set up your API key" above)
        const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

        const model = genAI.getGenerativeModel({model: aiModel});
        const result = await model.generateContent(finalPrompt);
        const response = await result.response;
        const text = response.text();
        console.log("------------------------- Original Response ----------------");
        console.log(text);
        console.log("\n\n");
        console.log("------------------------- Formatted Response ----------------");
        const formattedResponse = formatMarkdown(text);
        console.log(formattedResponse);
        updateGeminiResponse(formattedResponse);
        return formattedResponse;
    }

    async function getChatGPTResponse(context, finalPrompt) {
        const apiUrl = 'https://api.openai.com/v1/chat/completions';

        const payload = {
            model: 'gpt-3.5-turbo-0613', // Or any other desired ChatGPT model
            messages: [{
                role: 'system',
                content: context
            },
                {role: 'user', content: finalPrompt}],
            max_tokens: 150, // Adjust as needed for desired response length
            temperature: 0.7, // Adjust for creativity and coherence
        };

        try {
            console.log(`Using API Key: ${CHATGPT_API_KEY}`);
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CHATGPT_API_KEY}`,
                },
                body: JSON.stringify(payload),
            });

            const data = await response.json();
            if (!data.choices || data.choices.length === 0 || !data.choices[0].message) {
                console.error('Unexpected response format:', data);
                return 'Error: Unexpected response format from ChatGPT.';
            }
            const chatGPTResponse = data.choices[0].message.content;
            console.log('------------------------- Original ChatGPT Response ----------------');
            console.log(chatGPTResponse);
            console.log("\n\n");
            console.log('------------------------- Formatted Response ----------------');
            const formattedResponse = formatMarkdown(chatGPTResponse); // Assuming you have a formatMarkdown function
            console.log(formattedResponse);
            updateChatGptResponse(formattedResponse);
            return formattedResponse;
        } catch (error) {
            console.error('Error fetching ChatGPT response:', error);
            return 'Error: Could not retrieve response from ChatGPT.';
        }
    }


    function setLocalStorage(GEMINI_API_KEY, CHATGPT_API_KEY, resumeText, jobDescriptionText) {
        localStorage.setItem('geminiApiKey', GEMINI_API_KEY);
        localStorage.setItem('chatGpTApiKey', CHATGPT_API_KEY);
        localStorage.setItem('resume', resumeText);
        localStorage.setItem('jobDescription', jobDescriptionText);
    }

    function retriveLocalStrorageValues() {
        // Retrieve values from local storage on page load (if they exist)
        localStorage.setItem('chatGpTApiKey', CHATGPT_API_KEY);
        const chatGpTApiKey = localStorage.getItem('apiKey');
        const storedAPIKey = localStorage.getItem('geminiApiKey');
        const storedResumeText = localStorage.getItem('resume');
        const storedJobDescriptionText = localStorage.getItem('jobDescription');

        if (storedAPIKey) {
            document.getElementById("geminiApiKey").value = storedAPIKey;
        }
        if (chatGpTApiKey) {
            document.getElementById("chatGpTApiKey").value = chatGpTApiKey;
        }
        if (storedResumeText) {
            document.getElementById("resume").value = storedResumeText;
        }
        if (storedJobDescriptionText) {
            document.getElementById("jobDescription").value = storedJobDescriptionText;
        }
    }

    function formatMarkdown(markdownText) {
        console.log("Before Converting : \n");
        console.log(markdownText)
        const converter = new showdown.Converter();
        const html = converter.makeHtml(markdownText);
        console.log("After Converting : \n");
        console.log(html);
        return html;
    }

</script>


</body>
</html>